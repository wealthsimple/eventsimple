# frozen_string_literal: true

class Create<%= model_name.camelize %>Events < ActiveRecord::Migration[7.0]
  def change
    create_table :<%= model_name.underscore %>_events do |t|
      # Change this to string if your aggregates primary key is a string type
      t.bigint :aggregate_id, null: false, index: true
      t.string :idempotency_key, null: true
      t.string :type, null: false
      t.json :data, null: false, default: {}
      t.json :metadata, null: false, default: {}

      t.datetime :created_at, null: false, default: -> { 'CURRENT_TIMESTAMP' }
      t.datetime, updated_at, null: false, default: -> { 'CURRENT_TIMESTAMP' }

      t.index :idempotency_key, unique: true
    end

    # Enables optimistic locking on the evented table
    add_column :<%= model_name.underscore.pluralize %>, :lock_version, :integer, default: 0, null: false
  end
end
